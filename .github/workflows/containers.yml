name: Update Runner Container Image

on:
  schedule:
    - cron: '0 * * * *'

jobs:
  check-for-new-release:
    runs-on: ubuntu-latest
    steps:
      - name : Check for new release
        id : check-release
        run : |
          LATEST_RELEASE=$(curl -sL https://api.github.com/repos/mantidproject/mantid/releases | jq -r '[.[] | select(.tag_name | test("^v\\d+\\.\\d+$"))][0].tag_name')
          echo "::set-output name=release_tag::$LATEST_RELEASE"

  build-and-push:
    needs: check-for-new-release
    if: ${{ steps.check-release.outputs.release_tag }}
    runs-on: ubuntu-latest
    steps:
      - name : Check out code
        uses : actions/checkout@v2

      - name : Set up Docker Buildx
        uses : docker/setup-buildx-action@v1

      - name : Login to GitHub Container Registry
        uses : docker/login-action@v1,
        with :
          registry : ghcr.io,
          username : ${{ secrets.GHCR_USERNAME }},
          password : ${{ secrets.GHCR_TOKEN }}

      - name : Build and push Docker image
        uses : docker/build-push-action@v2,
        with :
          context : .,
          push:true,
          tags : ghcr.io/interactivereduction/runner

      - name: Get image SHA256 digest
        id: get-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/interactivereduction/runner)
          echo "::set-output name=digest::$DIGEST"

      - name: Update .py file
        run: |
          sed -i "s/^sha256:.*$/sha256:${{ steps.get-digest.outputs.digest }}/" jobcontroller/jobcreator.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Update image SHA256 digest
          title: Update image SHA256 digest
          body: |
            This PR updates the SHA256 digest of the `ghcr.io/interactivereduction/runner` image in `path/to/file.py`.